<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>

  <style>
    body { font-family: Inter, sans-serif; }
    .sidebar-link:hover { background: rgba(0,0,0,0.06); }
  </style>
</head>

<body class="bg-gray-100">

  <!-- ================================
          HEADER (TOP NAV)
  =================================== -->
  <header class="bg-white shadow fixed top-0 left-0 right-0 h-16 flex items-center justify-between px-6 z-50">

    <!-- Left: Mobile Menu Button -->
    <button id="menuBtn" class="md:hidden text-gray-700">
      <i data-feather="menu" class="w-6 h-6"></i>
    </button>

    <!-- Center Title -->
    <h1 class="text-xl font-bold text-blue-700">Job-Fit Dashboard</h1>

    <!-- Right Side -->
    <div class="flex items-center gap-4 text-sm">
      <a href="/" class="text-blue-600 hover:underline font-medium">‚Üê Back to Home</a>
      <span id="userName" class="font-medium"></span>
      <a href="/logout" class="text-red-500 font-medium hover:underline">Logout</a>
    </div>
  </header>

  <!-- ================================
            SIDEBAR
  =================================== -->
  <aside
    id="sidebar"
    class="fixed top-16 left-0 w-60 bg-white h-[calc(100vh-64px)] shadow-md p-5 transform -translate-x-full md:translate-x-0 transition-transform duration-300">

    <nav class="space-y-2 text-sm">
      <a href="/" class="sidebar-link flex items-center gap-3 p-2 rounded font-medium text-blue-600">
        <i data-feather="arrow-left"></i> <span>Back to Home</span>
      </a>

      <a href="#saved" class="sidebar-link flex items-center gap-3 p-2 rounded">
        <i data-feather="folder"></i> <span>Saved CVs</span>
      </a>

      <a href="#past" class="sidebar-link flex items-center gap-3 p-2 rounded">
        <i data-feather="repeat"></i> <span>Past Optimizations</span>
      </a>

      <a href="#subscription" class="sidebar-link flex items-center gap-3 p-2 rounded">
        <i data-feather="credit-card"></i> <span>Subscription Status</span>
      </a>

      <a href="#profile" class="sidebar-link flex items-center gap-3 p-2 rounded">
        <i data-feather="settings"></i> <span>Profile Settings</span>
      </a>
    </nav>

  </aside>

  <!-- ================================
          MAIN CONTENT
  =================================== -->
  <main class="md:ml-64 mt-20 p-6 md:p-8 transition-all">

    <!-- QUICK STATS -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
      <div class="bg-white shadow rounded-lg p-5">
        <p class="text-gray-500 text-sm">Saved CVs</p>
        <p id="statsSaved" class="text-2xl font-bold">0</p>
      </div>

      <div class="bg-white shadow rounded-lg p-5">
        <p class="text-gray-500 text-sm">Past Optimizations</p>
        <p id="statsPast" class="text-2xl font-bold">0</p>
      </div>

      <div class="bg-white shadow rounded-lg p-5">
        <p class="text-gray-500 text-sm">Subscription</p>
        <p id="statsSub" class="text-2xl font-bold">Loading...</p>
      </div>
    </div>

    <!-- SAVED CVS -->
    <section id="saved" class="bg-white shadow rounded-lg p-6 mb-10">
      <h2 class="text-xl font-semibold text-blue-700 mb-4">Saved CVs</h2>
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b bg-gray-50">
            <th class="p-3 text-left">Filename</th>
            <th class="p-3 text-left">Date</th>
            <th class="p-3 text-left">Download</th>
          </tr>
        </thead>
        <tbody id="savedCVsTable">
          <tr><td colspan="3" class="p-4 text-gray-500 text-center">Loading...</td></tr>
        </tbody>
      </table>
    </section>

    <!-- PAST OPTIMIZATIONS -->
    <section id="past" class="bg-white shadow rounded-lg p-6 mb-10">
      <h2 class="text-xl font-semibold text-blue-700 mb-4">Past Optimizations</h2>
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b bg-gray-50">
            <th class="p-3 text-left">Filename</th>
            <th class="p-3 text-left">Date</th>
            <th class="p-3 text-left">Download</th>
          </tr>
        </thead>
        <tbody id="pastOptimizationsTable">
          <tr><td colspan="3" class="p-4 text-gray-500 text-center">Loading...</td></tr>
        </tbody>
      </table>
    </section>

    <!-- SUBSCRIPTION -->
    <section id="subscription" class="bg-white shadow rounded-lg p-6 mb-10">
      <h2 class="text-xl font-semibold text-blue-700 mb-4">Subscription Status</h2>
      <p id="subscriptionStatus" class="text-gray-700 text-lg">Loading...</p>
    </section>

    <!-- PROFILE SETTINGS -->
    <section id="profile" class="bg-white shadow rounded-lg p-6">
      <h2 class="text-xl font-semibold text-blue-700 mb-4">Profile Settings</h2>

      <p class="mb-2"><strong>Name:</strong> <span id="profileName"></span></p>
      <p class="mb-4"><strong>Email:</strong> <span id="profileEmail"></span></p>

      <button id="updateProfileBtn"
        class="px-5 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">
        Update Profile
      </button>
    </section>

  </main>

  <!-- ================================
           SCRIPT SECTION
  =================================== -->
  <script>
    feather.replace();

    // Mobile Sidebar Toggle
    const menuBtn = document.getElementById("menuBtn");
    const sidebar = document.getElementById("sidebar");

    menuBtn.addEventListener("click", () => {
      sidebar.classList.toggle("-translate-x-full");
    });

    async function fetchJSON(url) {
      const res = await fetch(url);
      if (res.status === 401) {
        window.location.href = "/";
        return null;
      }
      return res.json();
    }

    async function loadDashboard() {
      try {
        const data = await fetchJSON("/api/user");
        if (!data) return;

        const user = data.user;
        document.getElementById("userName").innerText = user.name;
        document.getElementById("profileName").innerText = user.name;
        document.getElementById("profileEmail").innerText = user.email;

        // Saved CVs
        const savedData = await fetchJSON("/api/saved-cvs") || [];
        const savedTbody = document.getElementById("savedCVsTable");

        document.getElementById("statsSaved").innerText = savedData.length;

        savedTbody.innerHTML =
          savedData.length === 0
            ? `<tr><td colspan="3" class="p-4 text-gray-500 text-center">No saved CVs yet.</td></tr>`
            : savedData.map(cv => `
              <tr class="border-b">
                <td class="p-3">${cv.filename}</td>
                <td class="p-3">${new Date(cv.date).toLocaleString()}</td>
                <td class="p-3">
                  <a href="/generated/${cv.filename}" class="text-blue-600 hover:underline">Download</a>
                </td>
              </tr>`).join('');

        // Past Optimizations
        const pastData = await fetchJSON("/api/past-optimizations") || [];
        const pastTbody = document.getElementById("pastOptimizationsTable");

        document.getElementById("statsPast").innerText = pastData.length;

        pastTbody.innerHTML =
          pastData.length === 0
            ? `<tr><td colspan="3" class="p-4 text-gray-500 text-center">No past optimizations yet.</td></tr>`
            : pastData.map(opt => `
              <tr class="border-b">
                <td class="p-3">${opt.filename}</td>
                <td class="p-3">${new Date(opt.date).toLocaleString()}</td>
                <td class="p-3">
                  <a href="/generated/${opt.filename}" class="text-blue-600 hover:underline">Download</a>
                </td>
              </tr>`).join('');

        // Subscription
        const subData = await fetchJSON("/api/subscription-status") || {};
        const active = subData.active ? "Active" : "Inactive";

        document.getElementById("subscriptionStatus").innerText = active;
        document.getElementById("statsSub").innerText = active;

      } catch (err) {
        console.error("Dashboard load error:", err);
      }
    }

    loadDashboard();
  </script>
</body>
</html>

